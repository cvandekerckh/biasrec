{% extends "main/base_rate.html" %}

{% block content %}

  <body>
    <form id="surveyForm" action="/survey1" method="post">
      <h1 class="titlecolor"><b>Hi, User {{ current_user.code }}! Could you please rate all the following movies ? </b></h1>
      {% for product in products %}
        {% if product.id in [1080,260,1387,1380,1214,1196,1258,858,1210,616,344,2571,593,356,480,780,253,318,595,1,4973,4993,4226,7361,3793,4896,8874,4878,6539,4306,88163,79132,91529,97921,84152,109487,83134,99114,98809,76093] %}
          <div>
            <p>
                <table class="table table-hover">
                    <tr>
                        <td width="200px", ALIGN="CENTER", style="float:left;width:40%;">
                            <br>
                            <br>
                            <img src="{{ url_for('static', filename='img/{}.jpg'.format(product.image))}}"  height="350px">
                        </td>
                        <td style="float:left;width:40%;">
                            <h2><b>{{product.name}}</b></h2>
                            <ul>
                              <li><h4><b>Year :</b> {{product.feature_1}}</h4></li>
                              <li><h4><b>Genre(s) :</b> {{product.feature_2}}</h4></li>
                              <li><h4><b>Actors :</b> {{product.feature_3}}</h4></li>
                              <li><h4><b>User score :</b> {{product.feature_4}}</h4></li>
                              <li style="text-align: justify;">
                                <h4><b>Overview :</b><i> {{product.nutri_score}}</i></h4>
                              </li>                           
                              <h4> <a href="{{ product.price }}">Click to watch the trailer</a> </h4> 
                            </ul>
                            <br>
                            <div class="rate">
                              <h3><b>Please rate this movie by clicking on a star</b></h3> 
                              <div id="{{ product.id }}"></div>
                              <h3 style="color: #ffe000"><b>Your rating : <div id="user_score_{{ product.id }}">{{ ratings[products.index(product)] }}</div></b></h3>
                          </div>
                        </td>
                    </tr>
                </table>
            </p>
          </div>
        {% endif %}
      {% endfor %}

      <h3 style="color: rgb(89, 108, 71); text-align: right;">Please submit your answers by clicking on this button :</h3>
      <div style="text-align: right;">
          <input type="submit" value="Submit" class="btn btn-primary btn-lg" style="font-size: 20px;">
      </div>
      <h4 style="text-align: right; color: red;">Make sure to rate all the movies before submitting.</h4>
      <br><br>
    </form>
  </body>

{% endblock %}

{% block scripts %}

  <script>
    
    // Define a function to handle star clicks
    function handleStarClick(stars, productId) {
        let data = new FormData();
        data.append("stars", stars);
        data.append("product_id", productId);
        fetch("/save/", {
            method: "post",
            body: data
        })
        .then(res => res.text())
        .then(txt => {
            if (txt == "OK") { location.reload(); }
            else { alert(txt); }
        });
    }

    // Loop through products and ratings arrays for selected movies
    {% for product in products %}
      {% if product.id in [1080,260,1387,1380,1214,1196,1258,858,1210,616,344,2571,593,356,480,780,253,318,595,1,4973,4993,4226,7361,3793,4896,8874,4878,6539,4306,88163,79132,91529,97921,84152,109487,83134,99114,98809,76093] %}
        starry({
          target: document.getElementById("{{ product.id }}"),
          max: 5,
          now: {{ ratings[products.index(product)] }},
          click: stars => handleStarClick(stars, "{{ product.id }}")
        });
      {% endif %}
    {% endfor %}

    // Add JavaScript validation for form submission
    document.querySelector('#surveyForm').addEventListener('submit', function(event) {
        // Loop through ratings and check if any rating is 0
        {% for product in products %}
          {% if product.id in [1080,260,1387,1380,1214,1196,1258,858,1210,616,344,2571,593,356,480,780,253,318,595,1,4973,4993,4226,7361,3793,4896,8874,4878,6539,4306,88163,79132,91529,97921,84152,109487,83134,99114,98809,76093] %}
            if (document.getElementById("user_score_{{ product.id }}").innerText === '0') {
                alert('Please rate all the movies before submitting.');
                event.preventDefault();
                return;
            }
          {% endif %}
        {% endfor %}
        // Afficher le message de succ√®s
        alert("Your ratings have been successfully submitted! \n\nPlease wait a few moments.");
    });

  </script>
{% endblock %}

















